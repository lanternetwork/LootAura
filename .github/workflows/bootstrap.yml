name: Bootstrap YardSaleFinder
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - ".github/workflows/bootstrap.yml"

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Create minimal Next.js 14 + Tailwind scaffold (no installs)
        shell: bash
        run: |
          set -e
          mkdir -p "app/(marketing)" "app/(app)/explore" public styles ".github/workflows"

          cat > package.json << 'EOF'
          {
            "name": "yard-sale-finder",
            "private": true,
            "version": "0.1.0",
            "scripts": {
              "dev": "next dev",
              "build": "next build",
              "start": "next start",
              "lint": "eslint .",
              "typecheck": "tsc --noEmit",
              "test": "vitest run",
              "test:ui": "vitest",
              "test:e2e": "playwright test",
              "format": "prettier -w ."
            },
            "dependencies": {
              "next": "14.2.4",
              "react": "18.3.1",
              "react-dom": "18.3.1"
            },
            "devDependencies": {
              "autoprefixer": "^10.4.19",
              "postcss": "^8.4.38",
              "tailwindcss": "^3.4.9",
              "typescript": "^5.4.5",
              "@types/react": "^18.2.66",
              "@types/node": "^20.12.12",
              "eslint": "^8.57.0",
              "prettier": "^3.3.3",
              "vitest": "^2.0.5",
              "@testing-library/react": "^16.0.0",
              "@testing-library/user-event": "^14.5.2",
              "@testing-library/dom": "^10.4.0",
              "jsdom": "^25.0.0",
              "@playwright/test": "^1.46.0"
            }
          }
          EOF

          cat > tsconfig.json << 'EOF'
          {
            "compilerOptions": {
              "target": "ES2022",
              "lib": ["dom", "dom.iterable", "esnext"],
              "allowJs": false,
              "skipLibCheck": true,
              "strict": true,
              "noEmit": true,
              "esModuleInterop": true,
              "module": "esnext",
              "moduleResolution": "bundler",
              "resolveJsonModule": true,
              "isolatedModules": true,
              "jsx": "preserve",
              "incremental": true,
              "paths": { "@/*": ["./*"] }
            },
            "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx"],
            "exclude": ["node_modules"]
          }
          EOF

          cat > next-env.d.ts << 'EOF'
          /// <reference types="next" />
          /// <reference types="next/image-types/global" />
          EOF

          cat > postcss.config.js << 'EOF'
          module.exports = { plugins: { tailwindcss: {}, autoprefixer: {} } }
          EOF

          cat > tailwind.config.ts << 'EOF'
          import type { Config } from "tailwindcss"
          export default {
            content: ["./app/**/*.{ts,tsx}", "./components/**/*.{ts,tsx}"],
            theme: { extend: {} },
            plugins: []
          } satisfies Config
          EOF

          cat > app/globals.css << 'EOF'
          @tailwind base;
          @tailwind components;
          @tailwind utilities;
          body { min-height: 100vh; }
          EOF

          cat > app/layout.tsx << 'EOF'
          import "./globals.css"
          export default function RootLayout({ children }:{children:React.ReactNode}) {
            return (
              <html lang="en">
                <body className="min-h-screen bg-neutral-50 text-neutral-900">
                  {children}
                </body>
              </html>
            )
          }
          EOF

          cat > "app/(marketing)/page.tsx" << 'EOF'
          export default function Landing() {
            return (
              <main className="relative">
                <section className="bg-cover bg-center" style={{backgroundImage:'url(/hero.jpg)'}}>
                  <div className="backdrop-brightness-75 py-24 text-center text-white">
                    <h1 className="text-5xl font-extrabold">Find Amazing <span className="text-amber-300">Yard Sale Treasures</span></h1>
                    <p className="mt-4 text-lg max-w-2xl mx-auto">Discover local yard sales, garage sales, and estate sales in your area. Never miss a great deal again!</p>
                    <div className="mt-8 flex justify-center gap-3">
                      <input aria-label="Enter city or zip" className="w-[480px] max-w-[90vw] rounded-lg px-4 py-3 text-neutral-900" placeholder="Enter your city or zip code" />
                      <a href="/explore" className="rounded-lg bg-amber-500 px-5 py-3 font-semibold">Find Sales</a>
                    </div>
                    <div className="mt-4 flex justify-center gap-4">
                      <a className="rounded border px-4 py-2 bg-white/90 text-neutral-800" href="/explore#map">View Map</a>
                      <a className="rounded border px-4 py-2 bg-white/90 text-neutral-800" href="/explore#add">Post Your Sale</a>
                    </div>
                  </div>
                </section>
              </main>
            )
          }
          EOF

          cat > "app/(app)/explore/page.tsx" << 'EOF'
          'use client'
          export default function Explore(){
            return (
              <main className="max-w-6xl mx-auto p-4">
                <h1 className="text-3xl font-bold mb-2">Explore Yard Sales</h1>
                <p className="text-neutral-600 mb-4">Browse, search, and discover amazing deals in your neighborhood.</p>
                <div className="py-12 text-neutral-500">Scaffold ready. Next steps will add tabs, list, map, and form.</div>
              </main>
            )
          }
          EOF

          cat > .gitignore << 'EOF'
          node_modules
          .next
          .vercel
          *.log
          .env*
          EOF

      - name: Commit to unique bootstrap branch
        env:
          BRANCH: bootstrap/step-a-${{ github.run_id }}
        run: |
          git config user.name "lanternetbot"
          git config user.email "bot@example.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "feat(bootstrap): Minimal Next.js 14 + Tailwind scaffold (Step A) [no installs]"

      - name: Push branch and open PR via API
        env:
          REPO: lanternetwork/YardSaleTracker
          TOKEN: ${{ secrets.BOT_TOKEN }}
          BRANCH: bootstrap/step-a-${{ github.run_id }}
        run: |
          set -e
          git push "https://x-access-token:${TOKEN}@github.com/${REPO}.git" HEAD:"$BRANCH"
          curl -s -X POST \
            -H "Authorization: token ${TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${REPO}/pulls \
            -d "{\"title\":\"Step A: Scaffold (Minimal Next.js + Tailwind)\",\"head\":\"${BRANCH}\",\"base\":\"main\",\"body\":\"Bootstrap scaffold for YardSaleFinder. Next steps will add pages and components.\"}"
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
