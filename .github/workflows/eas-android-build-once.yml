name: EAS Android Build (One-Time)

on:
  workflow_dispatch:
  push:
    branches:
      - test/ci-featured-email-starter-harness
    paths:
      - '.github/workflows/eas-android-build-once.yml'

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: mobile
        run: npm install

      - name: Install EAS CLI
        working-directory: mobile
        run: npm install -g eas-cli@latest

      - name: Setup Android credentials
        working-directory: mobile
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "Checking Android credentials..."
          # Try to setup credentials if they don't exist
          eas credentials --platform android --non-interactive || echo "Credentials check completed"
          
      - name: Build Android AAB
        working-directory: mobile
        id: build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "Starting Android AAB build..."
          # Use --no-wait first to get build ID, then wait
          eas build --platform android --profile production --non-interactive --no-wait
          
          # Wait a moment for build to be registered
          sleep 5
          
          # Get the latest build ID (the one we just started)
          BUILD_ID=$(eas build:list --platform android --limit 1 --json | node -e "
            try {
              const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
              console.log(data[0]?.id || '');
            } catch (e) {
              console.log('');
            }
          ")
          
          if [ -z "$BUILD_ID" ]; then
            echo "Error: Could not determine build ID"
            exit 1
          fi
          
          echo "buildId=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Android Build ID: $BUILD_ID"
          
          # Get build details and download URL
          BUILD_INFO=$(eas build:view --id "$BUILD_ID" --json 2>/dev/null || echo "{}")
          BUILD_URL=$(echo "$BUILD_INFO" | node -e "
            try {
              const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
              console.log(data.artifacts?.buildUrl || data.artifacts?.url || data.url || '');
            } catch (e) {
              console.log('');
            }
          ")
          
          if [ -z "$BUILD_URL" ]; then
            USERNAME=$(eas whoami --json 2>/dev/null | node -e "try { const d = JSON.parse(require('fs').readFileSync(0, 'utf-8')); console.log(d.username || ''); } catch(e) { console.log(''); }" || echo '')
            if [ -n "$USERNAME" ]; then
              BUILD_URL="https://expo.dev/accounts/$USERNAME/builds/$BUILD_ID"
            fi
          fi
          
          echo "buildUrl=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "AAB Download URL: $BUILD_URL"
          
          # Wait for build to complete
          echo "Waiting for build to complete..."
          eas build:wait --id "$BUILD_ID" --timeout 3600
          
          # Get final build status and URL
          BUILD_INFO=$(eas build:view --id "$BUILD_ID" --json 2>/dev/null || echo "{}")
          FINAL_URL=$(echo "$BUILD_INFO" | node -e "
            try {
              const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
              console.log(data.artifacts?.buildUrl || data.artifacts?.url || data.url || '');
            } catch (e) {
              console.log('');
            }
          ")
          
          if [ -n "$FINAL_URL" ] && [ "$FINAL_URL" != "$BUILD_URL" ]; then
            echo "buildUrl=$FINAL_URL" >> $GITHUB_OUTPUT
            echo "Final AAB Download URL: $FINAL_URL"
          fi

      - name: Report results
        run: |
          echo "## Android AAB Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build ID" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.build.outputs.buildId }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AAB Download URL" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.build.outputs.buildUrl }}" >> $GITHUB_STEP_SUMMARY
          
          echo "Build ID: ${{ steps.build.outputs.buildId }}"
          echo "AAB Download URL: ${{ steps.build.outputs.buildUrl }}"
