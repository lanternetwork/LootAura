name: EAS Initialize and Build Android

on:
  workflow_dispatch:
  push:
    branches:
      - test/ci-featured-email-starter-harness
    paths:
      - '.github/workflows/eas-init-and-build.yml'

jobs:
  eas-init-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: mobile
        run: |
          npm install

      - name: Install EAS CLI
        working-directory: mobile
        run: |
          npm install -g eas-cli@latest

      - name: Authenticate with Expo
        working-directory: mobile
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas login --non-interactive

      - name: Initialize EAS project
        working-directory: mobile
        id: eas-init
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          # Check current projectId
          CURRENT_ID=$(node -e "const app = require('./app.json'); console.log(app.expo.extra?.eas?.projectId || '')")
          
          if [ -z "$CURRENT_ID" ] || [ "$CURRENT_ID" == "<INSERT_EAS_PROJECT_ID>" ]; then
            echo "Initializing EAS project..."
            # Initialize EAS project (non-interactive)
            # This will create the project and update app.json
            eas init --non-interactive || {
              echo "EAS init failed, trying alternative method..."
              # Alternative: use eas project:init
              eas project:init --non-interactive || exit 1
            }
          fi
          
          # Extract projectId from app.json after initialization
          PROJECT_ID=$(node -e "const app = require('./app.json'); console.log(app.expo.extra?.eas?.projectId || '')")
          
          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" == "<INSERT_EAS_PROJECT_ID>" ]; then
            echo "Error: Failed to get project ID"
            exit 1
          fi
          
          echo "projectId=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "EAS Project ID: $PROJECT_ID"

      - name: Update app.json with projectId
        working-directory: mobile
        if: steps.eas-init.outputs.projectId != '' && steps.eas-init.outputs.projectId != '<INSERT_EAS_PROJECT_ID>'
        run: |
          PROJECT_ID="${{ steps.eas-init.outputs.projectId }}"
          node -e "
            const fs = require('fs');
            const app = require('./app.json');
            app.expo.extra.eas.projectId = '$PROJECT_ID';
            fs.writeFileSync('./app.json', JSON.stringify(app, null, 2) + '\n');
          "

      - name: Commit projectId change
        if: steps.eas-init.outputs.projectId != '' && steps.eas-init.outputs.projectId != '<INSERT_EAS_PROJECT_ID>'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add mobile/app.json
          git commit -m "Initialize EAS project and set projectId" || exit 0
          git push origin HEAD:test/ci-featured-email-starter-harness || exit 0

      - name: Build Android AAB
        working-directory: mobile
        id: eas-build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          # Build Android AAB and capture output
          BUILD_OUTPUT=$(eas build --platform android --profile production --non-interactive 2>&1)
          echo "$BUILD_OUTPUT"
          
          # Extract build ID from output (EAS CLI outputs build URL/ID)
          BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oP 'build/[a-zA-Z0-9-]+' | head -1 | cut -d'/' -f2 || echo "")
          
          # If not found in output, get latest build
          if [ -z "$BUILD_ID" ]; then
            echo "Extracting build ID from build list..."
            BUILD_ID=$(eas build:list --platform android --limit 1 --json 2>/dev/null | node -e "
              try {
                const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
                console.log(data[0]?.id || '');
              } catch (e) {
                console.log('');
              }
            " || echo "")
          fi
          
          if [ -z "$BUILD_ID" ]; then
            echo "Error: Could not determine build ID"
            exit 1
          fi
          
          echo "buildId=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Android Build ID: $BUILD_ID"
          
          # Wait for build to complete (if not already complete)
          echo "Checking build status..."
          BUILD_STATUS=$(eas build:view --id "$BUILD_ID" --json 2>/dev/null | node -e "
            try {
              const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
              console.log(data.status || '');
            } catch (e) {
              console.log('');
            }
          " || echo "unknown")
          
          if [ "$BUILD_STATUS" != "finished" ] && [ "$BUILD_STATUS" != "completed" ]; then
            echo "Waiting for build to complete..."
            eas build:wait --id "$BUILD_ID" --timeout 3600 || {
              echo "Build wait timeout or failed, checking final status..."
            }
          fi
          
          # Get build details and download URL
          BUILD_INFO=$(eas build:view --id "$BUILD_ID" --json 2>/dev/null || echo "{}")
          BUILD_URL=$(echo "$BUILD_INFO" | node -e "
            try {
              const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
              console.log(data.artifacts?.buildUrl || data.artifacts?.url || '');
            } catch (e) {
              console.log('');
            }
          " || echo "")
          
          if [ -z "$BUILD_URL" ]; then
            # Try alternative method to get download URL
            BUILD_URL="https://expo.dev/accounts/$(eas whoami --json 2>/dev/null | node -e "try { const d = JSON.parse(require('fs').readFileSync(0, 'utf-8')); console.log(d.username || ''); } catch(e) { console.log(''); }" || echo '')/builds/$BUILD_ID"
          fi
          
          echo "buildUrl=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "AAB Download URL: $BUILD_URL"

      - name: Report results
        run: |
          echo "## EAS Initialization and Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### EAS Project ID" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.eas-init.outputs.projectId }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Android Build ID" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.eas-build.outputs.buildId }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AAB Download URL" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.eas-build.outputs.buildUrl }}" >> $GITHUB_STEP_SUMMARY
          
          echo "EAS Project ID: ${{ steps.eas-init.outputs.projectId }}"
          echo "Android Build ID: ${{ steps.eas-build.outputs.buildId }}"
          echo "AAB Download URL: ${{ steps.eas-build.outputs.buildUrl }}"
