name: Load Tests on Deployment

on:
  deployment_status:
    types: [created, success]

jobs:
  determine-url:
    # deployment_status events don't always carry github.ref, so gate purely on deployment state.
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      url: ${{ steps.url.outputs.url }}
    steps:
      - name: Determine target URL
        id: url
        shell: bash
        run: |
          set -euo pipefail
          # Prefer environment_url; fallback to deployment.payload.web_url; then target_url.
          URL="${{ github.event.deployment_status.environment_url }}"
          if [ -z "$URL" ]; then
            URL="${{ github.event.deployment.payload.web_url }}"
          fi
          if [ -z "$URL" ]; then
            URL="${{ github.event.deployment.target_url }}"
          fi
          if [ -z "$URL" ]; then
            echo "::notice::No deployment URL found; skipping load tests"
            echo "url=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "url=$URL" >> "$GITHUB_OUTPUT"

  run-on-success:
    needs: determine-url
    if: needs.determine-url.outputs.url != ''
    continue-on-error: true
    uses: ./.github/workflows/load-test.yml
    with:
      baseURL: ${{ needs.determine-url.outputs.url }}
      scenario: all
    secrets: inherit


