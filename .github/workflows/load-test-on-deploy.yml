name: Load Tests on Deployment

on:
  deployment_status:
    types: [created, success]

jobs:
  run-on-success:
    # Only run on successful deployments to main to avoid branch noise
    if: github.event.deployment_status.state == 'success' && github.ref == 'refs/heads/main'
    continue-on-error: ${{ github.ref != 'refs/heads/main' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Determine target URL
        id: url
        run: |
          # Prefer environment_url; fallback to target_url
          URL="${{ github.event.deployment_status.environment_url }}"
          if [ -z "$URL" ]; then
            URL="${{ github.event.deployment.payload?.web_url || github.event.deployment.target_url }}"
          fi
          if [ -z "$URL" ]; then
            echo "::notice::No deployment URL found; skipping load tests"
            # Do not fail the workflow when there's no URL (e.g., previewless deployments)
            echo "url=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Call reusable load-test workflow (all scenarios)
        uses: ./.github/workflows/load-test.yml
        with:
          baseURL: ${{ steps.url.outputs.url }}
          scenario: all


