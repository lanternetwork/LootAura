name: Load Tests on Deployment

on:
  deployment_status:
    types: [created, success]

jobs:
  determine-url:
    # Only run on successful deployments to main to avoid branch noise.
    # Note: deployment_status events don't always carry github.ref, so gate purely on deployment state
    # and use continue-on-error to avoid blocking CI when the event shape is missing fields.
    if: github.event.deployment_status.state == 'success'
    continue-on-error: true
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.url.outputs.url }}
    steps:
      - name: Determine target URL
        id: url
        run: |
          # Prefer environment_url; fallback to target_url
          URL="${{ github.event.deployment_status.environment_url }}"
          if [ -z "$URL" ]; then
            URL="${{ github.event.deployment.target_url }}"
          fi
          if [ -z "$URL" ]; then
            echo "::notice::No deployment URL found; skipping load tests"
            # Do not fail the workflow when there's no URL (e.g., previewless deployments)
            echo "url=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT

  run-load-tests:
    needs: determine-url
    if: needs.determine-url.outputs.url != ''
    uses: ./.github/workflows/load-test.yml
    with:
      baseURL: ${{ needs.determine-url.outputs.url }}
      scenario: all


