#!/usr/bin/env node

/**
 * Uploads sourcemaps to Sentry after EAS build completes.
 * This script runs as a post-build hook in EAS builds.
 * 
 * Required environment variables (set in EAS Secrets):
 * - SENTRY_AUTH_TOKEN: Sentry authentication token
 * - SENTRY_ORG: Sentry organization slug
 * - SENTRY_PROJECT: Sentry project slug
 * - EXPO_PUBLIC_SENTRY_DSN: Sentry DSN (for release tag extraction)
 */

const { execSync } = require('child_process');
const path = require('path');
const fs = require('fs');

// Only run in production builds
if (process.env.EAS_BUILD_PROFILE !== 'production') {
  console.log('[Sentry] Skipping sourcemap upload (non-production build)');
  process.exit(0);
}

// Check required environment variables
const requiredEnvVars = ['SENTRY_AUTH_TOKEN', 'SENTRY_ORG', 'SENTRY_PROJECT', 'EXPO_PUBLIC_SENTRY_DSN'];
const missingVars = requiredEnvVars.filter(varName => !process.env[varName]);

if (missingVars.length > 0) {
  console.error(`[Sentry] Missing required environment variables: ${missingVars.join(', ')}`);
  console.error('[Sentry] Sourcemap upload skipped. Set these in EAS Dashboard â†’ Secrets.');
  process.exit(0);
}

// Extract release tag from DSN and app version
// Release format: com.lootaura.app@version+versionCode
const appJsonPath = path.join(__dirname, '..', 'app.json');
const appJson = JSON.parse(fs.readFileSync(appJsonPath, 'utf8'));
const version = appJson.expo.version || 'unknown';
const versionCode = appJson.expo.android?.versionCode || 'unknown';
const release = `com.lootaura.app@${version}+${versionCode}`;

console.log(`[Sentry] Uploading sourcemaps for release: ${release}`);

// For Expo/React Native EAS builds, sourcemaps are generated by Metro bundler.
// EAS builds output sourcemaps in the build directory. We need to find them.
// Common locations for EAS builds:
const platform = process.env.EAS_BUILD_PLATFORM || 'android';
const buildDir = process.env.EAS_BUILD_WORKINGDIR || process.cwd();

const possibleSourcemapPaths = [
  // Android (EAS build - Metro output)
  path.join(buildDir, 'android', 'app', 'build', 'generated', 'sourcemaps', 'react', 'release', 'index.android.bundle.map'),
  // Android (alternative Metro path)
  path.join(buildDir, 'android', 'app', 'build', 'intermediates', 'sourcemaps', 'release', 'index.android.bundle.map'),
  // Android (root build directory)
  path.join(buildDir, 'index.android.bundle.map'),
  // iOS (EAS build - Metro output)
  path.join(buildDir, 'ios', 'build', 'Build', 'Products', 'Release-iphoneos', 'main.jsbundle.map'),
  // iOS (alternative path)
  path.join(buildDir, 'main.jsbundle.map'),
  // Check for any .map files in common build directories
  ...(platform === 'android' 
    ? [
        path.join(buildDir, 'android', 'app', 'build', '**', '*.map'),
        path.join(buildDir, '*.android.bundle.map'),
      ]
    : [
        path.join(buildDir, 'ios', '**', '*.jsbundle.map'),
        path.join(buildDir, '*.jsbundle.map'),
      ]
  ),
];

// Find the first existing sourcemap file
let sourcemapPath = null;
for (const possiblePath of possibleSourcemapPaths) {
  // Skip glob patterns for now (would need glob library)
  if (possiblePath.includes('**')) continue;
  
  if (fs.existsSync(possiblePath)) {
    sourcemapPath = possiblePath;
    break;
  }
}

if (!sourcemapPath) {
  console.warn('[Sentry] No sourcemap file found in expected locations.');
  console.warn(`[Sentry] Searched in: ${buildDir}`);
  console.warn('[Sentry] EAS may generate sourcemaps in a different location.');
  console.warn('[Sentry] Check EAS build logs for Metro bundler sourcemap output.');
  console.warn('[Sentry] Sourcemap upload skipped (non-blocking).');
  process.exit(0);
}

console.log(`[Sentry] Found sourcemap: ${sourcemapPath}`);

// Determine bundle file path (sourcemap without .map extension)
const bundlePath = sourcemapPath.replace(/\.map$/, '');
if (!fs.existsSync(bundlePath)) {
  console.warn(`[Sentry] Bundle file not found: ${bundlePath}`);
  console.warn('[Sentry] Uploading sourcemap without bundle file (may affect source mapping).');
}

try {
  // Upload sourcemaps using sentry-cli
  // sentry-cli releases files <release> upload-sourcemaps <path> --dist <dist>
  const dist = process.env.EAS_BUILD_PLATFORM === 'android' ? 'android' : 'ios';
  
  const uploadCommand = [
    'npx',
    '@sentry/cli',
    'releases',
    'files',
    release,
    'upload-sourcemaps',
    sourcemapPath,
    '--dist',
    dist,
    '--org',
    process.env.SENTRY_ORG,
    '--project',
    process.env.SENTRY_PROJECT,
    '--auth-token',
    process.env.SENTRY_AUTH_TOKEN,
  ].join(' ');

  console.log('[Sentry] Running sourcemap upload...');
  execSync(uploadCommand, { stdio: 'inherit' });
  console.log(`[Sentry] Successfully uploaded sourcemaps for release: ${release}`);
} catch (error) {
  console.error('[Sentry] Failed to upload sourcemaps:', error.message);
  // Don't fail the build if sourcemap upload fails
  process.exit(0);
}
