#!/usr/bin/env node

/**
 * Uploads sourcemaps to Sentry after EAS build completes.
 * This script runs as a post-build hook in EAS builds.
 * 
 * Required environment variables (set in EAS Secrets):
 * - SENTRY_AUTH_TOKEN: Sentry authentication token
 * - SENTRY_ORG: Sentry organization slug
 * - SENTRY_PROJECT: Sentry project slug
 */

const { execSync } = require('child_process');
const path = require('path');
const fs = require('fs');
const { globSync } = require('glob');

// Only run in production builds
if (process.env.EAS_BUILD_PROFILE !== 'production') {
  console.log('[Sentry] Skipping sourcemap upload (non-production build)');
  process.exit(0);
}

// Check required environment variables
const requiredEnvVars = ['SENTRY_AUTH_TOKEN', 'SENTRY_ORG', 'SENTRY_PROJECT'];
const missingVars = requiredEnvVars.filter(varName => !process.env[varName]);

if (missingVars.length > 0) {
  console.error(`[Sentry] SOURCEMAP_UPLOAD_FAILED: Missing required environment variables: ${missingVars.join(', ')}`);
  process.exit(0);
}

// Extract release tag from app version
// Release format: com.lootaura.app@version+versionCode
const appJsonPath = path.join(__dirname, '..', 'app.json');
const appJson = JSON.parse(fs.readFileSync(appJsonPath, 'utf8'));
const version = appJson.expo.version || 'unknown';
const versionCode = appJson.expo.android?.versionCode || 'unknown';
const release = `com.lootaura.app@${version}+${versionCode}`;

console.log(`[Sentry] Uploading sourcemaps for release: ${release}`);

// For Expo/React Native EAS builds, sourcemaps are generated by Metro bundler.
// EAS builds output sourcemaps in the build directory. We need to find them.
const platform = process.env.EAS_BUILD_PLATFORM || 'android';
const buildDir = process.env.EAS_BUILD_WORKINGDIR || process.cwd();

// First, try hardcoded common paths (fast check)
const hardcodedPaths = [
  // Android (EAS build - Metro output)
  path.join(buildDir, 'android', 'app', 'build', 'generated', 'sourcemaps', 'react', 'release', 'index.android.bundle.map'),
  // Android (alternative Metro path)
  path.join(buildDir, 'android', 'app', 'build', 'intermediates', 'sourcemaps', 'release', 'index.android.bundle.map'),
  // Android (root build directory)
  path.join(buildDir, 'index.android.bundle.map'),
  // iOS (EAS build - Metro output)
  path.join(buildDir, 'ios', 'build', 'Build', 'Products', 'Release-iphoneos', 'main.jsbundle.map'),
  // iOS (alternative path)
  path.join(buildDir, 'main.jsbundle.map'),
];

let sourcemapPath = null;

// Check hardcoded paths first (fast)
for (const possiblePath of hardcodedPaths) {
  if (fs.existsSync(possiblePath)) {
    sourcemapPath = possiblePath;
    break;
  }
}

// If not found, use glob search (robust fallback)
if (!sourcemapPath) {
  try {
    // Search for all .map files with max depth of 5, ignoring irrelevant directories
    const allSourcemaps = globSync('**/*.map', {
      cwd: buildDir,
      maxDepth: 5,
      absolute: true,
      ignore: [
        '**/node_modules/**',
        '**/.git/**',
        '**/.expo/**',
        '**/dist/**',
        '**/build/**/test/**',
        '**/build/**/tests/**',
      ],
    });

    // Filter for likely sourcemap files (bundle-related, not test files)
    const candidateSourcemaps = allSourcemaps.filter(file => {
      const basename = path.basename(file);
      const dirname = path.dirname(file);
      
      // Skip test files
      if (basename.includes('test') || basename.includes('spec')) {
        return false;
      }
      
      // Prefer bundle-related sourcemaps
      const isBundleRelated = 
        basename.includes('bundle') || 
        basename.includes('index') ||
        basename.endsWith('.bundle.map') ||
        basename.endsWith('.jsbundle.map');
      
      // Platform-specific preference
      if (platform === 'android') {
        return isBundleRelated && (
          basename.includes('android') || 
          basename.includes('index') ||
          !basename.includes('ios')
        );
      } else {
        return isBundleRelated && (
          basename.includes('ios') || 
          basename.includes('main') ||
          !basename.includes('android')
        );
      }
    });

    // Prefer platform-specific sourcemaps
    if (candidateSourcemaps.length > 0) {
      const platformSpecific = candidateSourcemaps.find(f => 
        platform === 'android' 
          ? (f.includes('android') || path.basename(f).includes('index'))
          : (f.includes('ios') || path.basename(f).includes('main'))
      );
      sourcemapPath = platformSpecific || candidateSourcemaps[0];
    }
  } catch (globError) {
    // Glob search failed, continue to error handling below
    console.warn(`[Sentry] Glob search failed: ${globError.message}`);
  }
}

if (!sourcemapPath) {
  console.error('[Sentry] SOURCEMAP_UPLOAD_FAILED: No sourcemap file found in build directory');
  console.error(`[Sentry] Searched in: ${buildDir}`);
  process.exit(0);
}

console.log(`[Sentry] Found sourcemap: ${sourcemapPath}`);

// Determine bundle file path (sourcemap without .map extension)
const bundlePath = sourcemapPath.replace(/\.map$/, '');
if (!fs.existsSync(bundlePath)) {
  console.warn(`[Sentry] Bundle file not found: ${bundlePath}`);
  console.warn('[Sentry] Uploading sourcemap without bundle file (may affect source mapping).');
}

try {
  // Upload sourcemaps using sentry-cli
  // sentry-cli releases files <release> upload-sourcemaps <path> --dist <dist>
  const dist = process.env.EAS_BUILD_PLATFORM === 'android' ? 'android' : 'ios';
  
  const uploadCommand = [
    'npx',
    '@sentry/cli',
    'releases',
    'files',
    release,
    'upload-sourcemaps',
    sourcemapPath,
    '--dist',
    dist,
    '--org',
    process.env.SENTRY_ORG,
    '--project',
    process.env.SENTRY_PROJECT,
    '--auth-token',
    process.env.SENTRY_AUTH_TOKEN,
  ].join(' ');

  console.log('[Sentry] Running sourcemap upload...');
  execSync(uploadCommand, { stdio: 'inherit' });
  console.log(`[Sentry] Successfully uploaded sourcemaps for release: ${release}`);
} catch (error) {
  console.error(`[Sentry] SOURCEMAP_UPLOAD_FAILED: Upload command failed: ${error.message}`);
  // Don't fail the build if sourcemap upload fails
  process.exit(0);
}
